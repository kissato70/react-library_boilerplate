var e=require("fs"),t=require("strip-ansi");module.exports=function(s){var r=(s=s||{}).sigint,o=s.eot,i=s.autocomplete=s.autocomplete||function(){return[]},n=s.history;return c.history=n||{save:function(){}},c.hide=function(e){return c(e,{echo:""})},c;function c(t,s,c){var u,l,p=0,d=0;c=c||{},Object(t)===t?t=(c=t).ask:Object(s)===s&&(s=(c=s).value),t=t||"";var f=c.echo,w="echo"in c;i=c.autocomplete||i;var h="win32"===process.platform?process.stdin.fd:e.openSync("/dev/tty","rs"),g=process.stdin.isRaw;g||process.stdin.setRawMode&&process.stdin.setRawMode(!0);var b,k,v=Buffer.alloc(3),G="";l="",t&&process.stdout.write(t);for(var S=0;;)if((k=e.readSync(h,v,0,3))>1)switch(v.toString()){case"[A":if(w)break;if(!n)break;if(n.atStart())break;n.atEnd()&&(l=G,d=p),p=(G=n.prev()).length,process.stdout.write("[2K[0G"+t+G);break;case"[B":if(w)break;if(!n)break;if(n.pastEnd())break;n.atPenultimate()?(G=l,p=d,n.next()):p=(G=n.next()).length,process.stdout.write("[2K[0G"+t+G+"["+(p+t.length+1)+"G");break;case"[D":if(w)break;p-(p=--p<0?0:p)&&process.stdout.write("[1D");break;case"[C":if(w)break;p=++p>G.length?G.length:p,process.stdout.write("["+(p+t.length+1)+"G");break;default:v.toString()&&(a(w,t,f,G=(G+=v.toString()).replace(/\0/g,""),p=G.length),process.stdout.write("["+(p+t.length+1)+"G"),v=Buffer.alloc(3))}else{if(3==(b=v[k-1]))return process.stdout.write("^C\n"),e.closeSync(h),r&&process.exit(130),process.stdin.setRawMode&&process.stdin.setRawMode(g),null;if(4==b&&0==G.length&&o&&(process.stdout.write("exit\n"),process.exit(0)),13==b){if(e.closeSync(h),!n)break;!w&&G.length&&n.push(G),n.reset();break}if(9==b){if(G==(u=i(G))[0]?u=i(""):u.length,0==u.length){process.stdout.write("\t");continue}var m=u[S++]||u[(S=0,S++)];m&&(process.stdout.write("\r[K"+t+m),G=m,p=m.length)}if(127==b||"win32"==process.platform&&8==b){if(!p)continue;G=G.slice(0,p-1)+G.slice(p),p--,process.stdout.write("[2D")}else{if(b<32||b>126)continue;G=G.slice(0,p)+String.fromCharCode(b)+G.slice(p),p++}a(w,t,f,G,p)}return process.stdout.write("\n"),process.stdin.setRawMode&&process.stdin.setRawMode(g),G||s||""}function a(e,s,r,o,i){if(e)process.stdout.write("[2K[0G"+s+Array(o.length+1).join(r));else{process.stdout.write("[s"),i==o.length||s?process.stdout.write("[2K[0G"+s+o):process.stdout.write("[2K[0G"+o+"["+(o.length-i)+"D");var n=t(s).length;process.stdout.write("[".concat(n+1+(""==r?0:i),"G"))}}};
